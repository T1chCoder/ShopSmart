{% load my_tags %}
<a href="{% url 'details:product' product.id %}" class="prdct-4 ovrfl-hdn bdr-rds-1 wdth-cvr flx-drt-cln">
    <div class="pstr ptn-rlv wdth-cvr flx-ctr">
        <div class="ptn-ablt cvr tp-cvr lft-cvr flx-ctr">
            <span class="flx-ctr cvr">
                <img src="{{product.product_poster.first.photo.url}}">
            </span>
        </div>
        <object class="lk tp-cvr rght-cvr ptn-ablt flx-ctr">
            {% if user.is_authenticated %}
            <button type="button" class="flx-ctr" id="btn-like-prdct-{{product.id}}">
                <span style="--fgr-sz: 20px;" class="fgr">
                    <svg width="20" height="20" viewBox="0 0 20 20"
                        fill="{% if product.id in wihslist_products %}#E85749{% else %}none{% endif %}"
                        xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_27_910)">
                            <path
                                d="M10 16.875C10 16.875 2.1875 12.5 2.1875 7.18751C2.1875 6.24836 2.51289 5.33821 3.1083 4.61193C3.70371 3.88564 4.53236 3.38808 5.45328 3.2039C6.37419 3.01971 7.33047 3.16029 8.15943 3.6017C8.98838 4.04311 9.63879 4.7581 10 5.62501C10.3612 4.7581 11.0116 4.04311 11.8406 3.6017C12.6695 3.16029 13.6258 3.01971 14.5467 3.2039C15.4676 3.38808 16.2963 3.88564 16.8917 4.61193C17.4871 5.33821 17.8125 6.24836 17.8125 7.18751C17.8125 12.5 10 16.875 10 16.875Z"
                                stroke="#E85749" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        </g>
                        <defs>
                            <clipPath id="clip0_27_910">
                                <rect width="20" height="20" fill="white" />
                            </clipPath>
                        </defs>
                    </svg>
                </span>
            </button>
            {% else %}
            <a href="{% url 'log-in' %}" class="flx-ctr">
                <span style="--fgr-sz: 20px;" class="fgr">
                    <svg width="20" height="20" viewBox="0 0 20 20"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_27_910)">
                            <path
                                d="M10 16.875C10 16.875 2.1875 12.5 2.1875 7.18751C2.1875 6.24836 2.51289 5.33821 3.1083 4.61193C3.70371 3.88564 4.53236 3.38808 5.45328 3.2039C6.37419 3.01971 7.33047 3.16029 8.15943 3.6017C8.98838 4.04311 9.63879 4.7581 10 5.62501C10.3612 4.7581 11.0116 4.04311 11.8406 3.6017C12.6695 3.16029 13.6258 3.01971 14.5467 3.2039C15.4676 3.38808 16.2963 3.88564 16.8917 4.61193C17.4871 5.33821 17.8125 6.24836 17.8125 7.18751C17.8125 12.5 10 16.875 10 16.875Z"
                                stroke="#E85749" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        </g>
                        <defs>
                            <clipPath id="clip0_27_910">
                                <rect width="20" height="20" fill="white" />
                            </clipPath>
                        </defs>
                    </svg>
                </span>
            </a>
            {% endif %}
        </object>
    </div>
    <div class="inf bdr-bx wdth-cvr flx-drt-cln">
        <div class="nm wdth-cvr flx-ctr flx-lft">
            <span style="--txt-ln-nbr: 2;" class="txt-ln">{{product.title}}</span>
        </div>
        {% if product.review_product.all|count > 0 %}
        <div style="gap: 2px;" class="rtng wdth-cvr flx-ctr flx-lft">
            <div class="flx-ctr">
                <span style="--fgr-sz: 16px;" class="fgr">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M8.00004 11.5133L12.12 14L11.0267 9.31334L14.6667 6.16001L9.87337 5.75334L8.00004 1.33334L6.12671 5.75334L1.33337 6.16001L4.97337 9.31334L3.88004 14L8.00004 11.5133Z"
                            fill="#E85749" />
                    </svg>
                </span>
            </div>
            <div style="height: 18px;" class="flx-ctr flx-tp">
                <h6>{{product.rating}} ({{product.review_product.all|count}})</h6>
            </div>
        </div>
        {% else %}
        <div style="height: 14px;" class="wdth-cvr flx-ctr"></div>
        {% endif %}
        <div class="wdth-cvr flx-ctr">
            <div class="wdth-cvr flx-spc-btwn">
                <div class="flx-ctr">
                    <div class="flx-drt-cln flx-tp">
                        <div class="prc flx-ctr">
                            <h6>{{product.act_price}} USD</h6>
                        </div>
                        <div class="act-prc flx-ctr">
                            <h4>{{product.price}} USD</h4>
                        </div>
                    </div>
                </div>
                <object class="flx-ctr">
                    {% if user.is_authenticated %}
                    <button type="button" class="flx-ctr{% if product.id in cart_products_id %} nn{% endif %}"
                        id="btn-prdct-add-to-crt-{{product.id}}">
                        <div class="flx-ctr">
                            <span style="--fgr-sz: 32px;" class="fgr">
                                <svg width="32" height="33" viewBox="0 0 32 33" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <g clip-path="url(#clip0_8_111)">
                                        <rect x="0.75" y="1.05005" width="30.5" height="30.5" rx="15.25"
                                            stroke="#E85749" stroke-width="1.1" />
                                        <path
                                            d="M12 14.3V12.3H10V16.8C10 17.0761 9.77614 17.3 9.5 17.3C9.22386 17.3 9 17.0761 9 16.8V11.3H12C12 8.89633 13.9523 7.30005 16 7.30005C18.0575 7.30005 20 9.00561 20 11.3H23V23.8C23 24.6284 22.3284 25.3 21.5 25.3H16.5C16.2239 25.3 16 25.0761 16 24.8C16 24.5239 16.2239 24.3 16.5 24.3H21.5C21.7761 24.3 22 24.0761 22 23.8V12.3H20V14.3H19V12.3H13V14.3H12ZM16 8.30005C14.4477 8.30005 13 9.50377 13 11.3H19C19 9.59449 17.5425 8.30005 16 8.30005Z"
                                            fill="#E85749" />
                                        <path
                                            d="M11.5 18.3C11.7761 18.3 12 18.5239 12 18.8V21.3H14.5C14.7761 21.3 15 21.5239 15 21.8C15 22.0761 14.7761 22.3 14.5 22.3H12V24.8C12 25.0761 11.7761 25.3 11.5 25.3C11.2239 25.3 11 25.0761 11 24.8V22.3H8.5C8.22386 22.3 8 22.0761 8 21.8C8 21.5239 8.22386 21.3 8.5 21.3H11V18.8C11 18.5239 11.2239 18.3 11.5 18.3Z"
                                            fill="#E85749" />
                                    </g>
                                    <defs>
                                        <clipPath id="clip0_8_111">
                                            <rect width="32" height="32" fill="white"
                                                transform="translate(0 0.300049)" />
                                        </clipPath>
                                    </defs>
                                </svg>
                            </span>
                        </div>
                    </button>
                    <a href="{% url 'cart' %}"
                        class="{% if product.id not in cart_products_id %}nn {% endif %}flx-ctr bdr-rds-cvr"
                        id="btn-prdct-go-to-crt-{{product.id}}">
                        <div class="flx-ctr">
                            <span style="--fgr-sz: 32px;" class="fgr">
                                <svg width="32" height="33" viewBox="0 0 32 33" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <g clip-path="url(#clip0_121_2980)">
                                        <g clip-path="url(#clip1_121_2980)">
                                            <mask id="mask0_121_2980" style="mask-type:luminance"
                                                maskUnits="userSpaceOnUse" x="0" y="0" width="32" height="33">
                                                <path d="M32 0.300049H0V32.3H32V0.300049Z" fill="white" />
                                            </mask>
                                            <g mask="url(#mask0_121_2980)">
                                                <path
                                                    d="M31.25 16.3C31.25 7.87771 24.4223 1.05005 16 1.05005C7.57766 1.05005 0.75 7.87771 0.75 16.3C0.75 24.7224 7.57766 31.55 16 31.55C24.4223 31.55 31.25 24.7224 31.25 16.3Z"
                                                    stroke="#E85749" stroke-width="1.1" />
                                                <path fill-rule="evenodd" clip-rule="evenodd"
                                                    d="M9 11.3C9 11.3 9 18 9 23.8C9 24.6284 9.67157 25.3 10.5 25.3C14.5 25.3 21.5 25.3 21.5 25.3C22.3284 25.3 23 24.6284 23 23.8V11.3H20C20 9.00561 18.0575 7.30005 16 7.30005C13.9523 7.30005 12 8.89633 12 11.3H9ZM13 11.3C13 9.50377 14.4477 8.30005 16 8.30005C17.5425 8.30005 19 9.59449 19 11.3H13Z"
                                                    fill="#E85749" />
                                                <path
                                                    d="M18.5325 15L17.8293 15.6803L14.9962 18.3071L14.1707 17.5701L13.4369 16.8898L12 18.222L12.7338 18.9024L14.2624 20.3197L14.9656 21L15.6994 20.3197L19.2662 17.0126L20 16.3323L18.5325 15Z"
                                                    fill="white" />
                                            </g>
                                        </g>
                                    </g>
                                    <defs>
                                        <clipPath id="clip0_121_2980">
                                            <rect width="32" height="33" fill="white" />
                                        </clipPath>
                                        <clipPath id="clip1_121_2980">
                                            <rect width="32" height="32" fill="white"
                                                transform="translate(0 0.300049)" />
                                        </clipPath>
                                    </defs>
                                </svg>
                            </span>
                        </div>
                    </a>
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            var buttonAdd = document.getElementById("btn-prdct-add-to-crt-{{product.id}}");
                            var goToCart = document.getElementById("btn-prdct-go-to-crt-{{product.id}}");

                            if (buttonAdd) {
                                buttonAdd.addEventListener('click', function (e) {
                                    e.preventDefault();
                                    var data = {
                                        sender_id: "{{user.id}}",
                                        product_id: "{{product.id}}",
                                        quantity: 1,
                                    };
                                    fetch("{% url 'forms:add-to-cart' %}", {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-CSRFToken': '{{csrf_token}}',
                                        },
                                        body: JSON.stringify(data)
                                    })
                                        .then(response => response.json())
                                        .then(data => {
                                            console.log(data.is_added)
                                            if (data.is_added) {
                                                if ("{{page}}" == "cart_page") {
                                                    window.location.reload();
                                                }
                                                else {
                                                    buttonAdd.classList.add("nn");
                                                    goToCart.classList.remove("nn");
                                                }
                                            }
                                        })
                                        .catch(error => {
                                            console.error("Error:", error);
                                        });
                                });
                            }
                        });
                    </script>
                    {% else %}
                    <a href="{% url 'log-in' %}" class="flx-ctr">
                        <div class="flx-ctr">
                            <span style="--fgr-sz: 32px;" class="fgr">
                                <svg width="32" height="33" viewBox="0 0 32 33" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <g clip-path="url(#clip0_8_111)">
                                        <rect x="0.75" y="1.05005" width="30.5" height="30.5" rx="15.25"
                                            stroke="#E85749" stroke-width="1.1" />
                                        <path
                                            d="M12 14.3V12.3H10V16.8C10 17.0761 9.77614 17.3 9.5 17.3C9.22386 17.3 9 17.0761 9 16.8V11.3H12C12 8.89633 13.9523 7.30005 16 7.30005C18.0575 7.30005 20 9.00561 20 11.3H23V23.8C23 24.6284 22.3284 25.3 21.5 25.3H16.5C16.2239 25.3 16 25.0761 16 24.8C16 24.5239 16.2239 24.3 16.5 24.3H21.5C21.7761 24.3 22 24.0761 22 23.8V12.3H20V14.3H19V12.3H13V14.3H12ZM16 8.30005C14.4477 8.30005 13 9.50377 13 11.3H19C19 9.59449 17.5425 8.30005 16 8.30005Z"
                                            fill="#E85749" />
                                        <path
                                            d="M11.5 18.3C11.7761 18.3 12 18.5239 12 18.8V21.3H14.5C14.7761 21.3 15 21.5239 15 21.8C15 22.0761 14.7761 22.3 14.5 22.3H12V24.8C12 25.0761 11.7761 25.3 11.5 25.3C11.2239 25.3 11 25.0761 11 24.8V22.3H8.5C8.22386 22.3 8 22.0761 8 21.8C8 21.5239 8.22386 21.3 8.5 21.3H11V18.8C11 18.5239 11.2239 18.3 11.5 18.3Z"
                                            fill="#E85749" />
                                    </g>
                                    <defs>
                                        <clipPath id="clip0_8_111">
                                            <rect width="32" height="32" fill="white"
                                                transform="translate(0 0.300049)" />
                                        </clipPath>
                                    </defs>
                                </svg>
                            </span>
                        </div>
                    </a>
                    {% endif %}
                </object>
            </div>
        </div>
    </div>
</a>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var buttonLike = document.getElementById("btn-like-prdct-{{product.id}}");

        if (buttonLike) {
            buttonLike.addEventListener('click', function (e) {
                e.preventDefault();
                var data = {
                    sender_id: "{{user.id}}",
                    product_id: "{{product.id}}",
                };
                fetch("{% url 'forms:like-product' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{csrf_token}}',
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(data => {
                        var svg = buttonLike.querySelector("svg");
                        if (data.is_liked) {
                            svg.removeAttribute("fill");
                            svg.setAttribute("fill", "#E85749");
                        }
                        else if (data.is_removed) {
                            svg.removeAttribute("fill");
                            svg.setAttribute("fill", "none");
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
            });
        }
    });
</script>